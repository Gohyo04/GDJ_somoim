<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <!-- mapper namespace는 비우면 에러 -->
  <mapper namespace="com.somoim.app.chat.ChatMessageDAO">

	<!-- 채팅 -->
  	<!-- parameter member(userName), chatRoom(chatRoomNum) -->
  	<insert id="addChat" parameterType="ChatMessageDTO">
  		INSERT INTO CHATMESSAGE 
			(MESSAGENUM, CHATROOMNUM, USERNAME, CHATTEXT, CHATTIMESTAMP)
		VALUES
			(MESSAGE_SEQ.NEXTVAL, 1, #{userName}, #{chatText}, SYSDATE)
  	</insert>
  	
  	<!-- 특정 채팅방의 채팅기록 -->
 	 <select id="chatHistory" parameterType="ChatMessageDTO" resultType="ChatMessageDTO">
  		SELECT * 
		FROM CHATMESSAGE
		WHERE CHATROOMNUM = #{chatRoomNum}
  	</select>
	
  	<!-- 채팅방 -->
  	<!-- 채팅방을 생성  -->
  	<insert id="addChatRoom">
  		INSERT INTO CHATROOM (CHATROOMNUM) VALUES (CHATROOM_SEQ.NEXTVAL)
  	</insert>

  	<!-- 채팅방이있는지 없는지 (chatRoomNum 중복체크) -->
  	<select id="chatRoomCh" resultType="Long">
  		SELECT DISTINCT CHATROOMNUM FROM CHATROOM
  	</select>

	<!-- 로그인한 유저의 채팅방 리스트 -->
 	<select id="chatRoomList" parameterType="MemberDTO" resultType="ChatMessageDTO">
		SELECT DISTINCT(CHATROOMNUM) 
		FROM CHATMESSAGE
		WHERE USERNAME = #{userName}
	</select>
  	
  	<!-- 특정 채팅방안의 유저수 ( 채팅방에 있는 사람 ) -->
  	<select id="chatRoomPerson" resultType="MemberDTO" parameterType="ChatMessageDTO">  	
		SELECT DISTINCT(USERNAME)
			FROM CHATROOM CR
				JOIN CHATMESSAGE CM
					USING(CHATROOMNUM)
				JOIN MEMBER M
					USING(USERNAME)
		WHERE CHATROOMNUM = #{chatRoomNum}
  	</select>
  </mapper>