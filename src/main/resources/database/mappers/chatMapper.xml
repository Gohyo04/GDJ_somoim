<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <!-- mapper namespace는 비우면 에러 -->
  <mapper namespace="com.somoim.app.chat.ChatMessageDAO">
  	
  	<!-- ChatRoom -->
  	<insert id="addChatRoom">
  		INSERT INTO CHATROOM (CHATROOMNUM) VALUES (CHATROOM_SEQ.NEXTVAL)
  	</insert>
  	  	
  	<select id="chatRoomCh" resultType="Long">
  		SELECT DISTINCT CHATROOMNUM FROM CHATROOM
  	</select>
  	
  	<select id="chatRoomList" parameterType="MemberDTO" resultType="Long">
  		SELECT DISTINCT CHATROOMNUM
			FROM CHATMESSAGE
		WHERE USERNAME = #{userName}
  	</select>
  	
  	<select id="roomUserList" parameterType="ChatMessageDTO" resultType="MemberDTO">
  		SELECT DISTINCT(USERNAME)
			FROM CHATROOM CR
				JOIN CHATMESSAGE CM
				USING(CHATROOMNUM)
				JOIN MEMBER M
				USING (USERNAME)
		WHERE CHATROOMNUM = #{chatRoomNum}
  	</select>
  	
  	<!-- Chat -->
  	<!-- parameter member(userName), chatRoom(chatRoomNum) -->
  	<insert id="addChat" parameterType="ChatMessageDTO">
  		INSERT INTO CHATMESSAGE 
			(MESSAGENUM, CHATROOMNUM, USERNAME, CHATTEXT, CHATTIMESTAMP)
		VALUES
			(MESSAGE_SEQ.NEXTVAL, #{chatRoomNum}, #{userName}, #{chatText}, SYSDATE)
  	</insert>

	<select id="chatHistory" parameterType="ChatMessageDTO" resultType="MemberDTO" resultMap="getRoomMember">
		SELECT * 
		FROM CHATMESSAGE
			JOIN MEMBER
			USING(USERNAME)
		WHERE CHATROOMNUM = #{chatRoomNum}
		ORDER BY CHATTIMESTAMP
	</select>
	
	<resultMap type="ChatMessageDTO" id="getRoomMember">
		<id column="MESSAGENUM" property="messageNum"/>
		<result column="CHATROOMNUM" property="chatRoomNum"/>
		<result column="USERNAME" property="userName"/>
		<result column="CHATTEXT" property="chatText"/>
		<result column="CHATTIMESTAMP" property="chatTimeStamp"/>
		
		<association property="memberDTO" javaType="MemberDTO">
			<id column="USERNAME" property="userName"/>
			<result column="NICKNAME" property="nickName"/>
			<result column="NAME" property="name"/>
		</association>
		
		<association property="profileDTO" javaType="ProfileDTO">
			<id column="USERNAME" property="userName"/>
			<result column="FILENUM" property="fileNum"/>
			<result column="FILENAME" property="fileName"/>
			<result column="ORINAME" property="oriName"/>
		</association>
	</resultMap>
	
	<select id="moimChatInfo" parameterType="MemberDTO" resultType="MoimDTO" resultMap="getRoomNumber">
		SELECT * 
			FROM MOIM
			JOIN MOIMCHAT
			USING (MOIMNUM)
		WHERE CHATROOMNUM IN
			(
				SELECT DISTINCT CHATROOMNUM  
				FROM CHATMESSAGE
				WHERE USERNAME = #{userName}
			)
	</select>
	
	<resultMap type="MoimDTO" id="getRoomNumber">
		<id column="MOIMNUM" property="moimNum"/>
		<result column="MOIMNAME" property="moimName"/>
		<result column="MOIMREGION" property="moimRegion"/>
		<result column="MOIMCATEGORY" property="moimCategory"/>
		<result column="MOIMDATE" property="moimDate"/>
		<result column="MOIMTEXT" property="moimText"/>
		<result column="MOIMMEMCOUNT" property="moimMemCount"/>
		<result column="MOIMHEAD" property="moimHead"/>
		
		<association property="chatRoomDTO" javaType="ChatRoomDTO">
			<id column="CHATROOMNUM" property="chatRoomNum"/>
		</association>
	</resultMap>
	
  </mapper>